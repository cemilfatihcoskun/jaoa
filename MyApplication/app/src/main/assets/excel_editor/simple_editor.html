<!DOCTYPE html>
<html>

<head lang='zh'>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Luckysheet</title>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #luckysheet {
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            top: 0;
            left: 0;
        }
        .luckysheet-wa-editor {
            max-width: 95% !important;
        }
        .luckysheet-modal-dialog,
        .luckysheet-cols-menu {
            max-width: 95% !important;
            left: 50% !important;
            transform: translateX(-50%) !important; /* Ortala */
            box-sizing: border-box;
            overflow-x: auto; /* Taşarsa kaydır */
        }
#luckysheet-rightclick-sheet-menu {
    position: fixed !important;
}
    </style>

    <!-- ✅ ORİJİNAL CSS DOSYALARI -->
    <link rel='stylesheet' href='./plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='./plugins/plugins.css' />
    <link rel='stylesheet' href='./css/luckysheet.css' />
    <link rel='stylesheet' href='./assets/iconfont/iconfont.css' />

    <!-- ✅ JQUERY ÖNCE YÜKLE -->
    <script>
        // Minimal jQuery eğer yoksa
        if (typeof $ === 'undefined') {
            window.$ = function(selector) {
                if (typeof selector === 'function') {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', selector);
                    } else {
                        setTimeout(selector, 0);
                    }
                    return;
                }
                return {
                    ready: function(fn) {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', fn);
                        } else {
                            setTimeout(fn, 0);
                        }
                    }
                };
            };
            window.jQuery = window.$;
        }
    </script>
    <!-- ✅ CDN MOCK'LARI - Hataları önlemek için -->
    <script>
        console.log('🚀 Luckysheet + CDN Mock başlatılıyor...');

        // Vue.js mock - CDN hatasını önler
        window.Vue = {
            use: function() { return this; },
            component: function() { return this; },
            directive: function() { return this; },
            filter: function() { return this; },
            mixin: function() { return this; },
            version: '2.6.11-mock'
        };

        // Vuex mock - CDN hatasını önler
        window.Vuex = {
            Store: function() {
                return {
                    state: {},
                    commit: function() {},
                    dispatch: function() {},
                    getters: {}
                };
            },
            install: function() {},
            version: '3.4.0-mock'
        };

        // Element UI mock - CDN hatasını önler
        window.ELEMENT = {
            size: 'small',
            zIndex: 3000
        };

        // ECharts mock - CDN hatasını önler
        window.echarts = {
            init: function(dom, theme, opts) {
                return {
                    setOption: function(option) {  },
                    resize: function() { },
                    dispose: function() {  },
                    clear: function() {  },
                    getWidth: function() { return 400; },
                    getHeight: function() { return 300; },
                    on: function() {},
                    off: function() {}
                };
            },
            graphic: {
                LinearGradient: function() { return {}; }
            },
            version: '4.8.0-mock',
            registerTheme: function() {},
            registerMap: function() {}
        };

        // ChartMix mock - expendPlugins hatasını önler
        window.chartmix = {
            init: function() { return {}; },
            create: function() { return {}; },
            version: '1.0.0-mock'
        };
    </script>
    <script src="./plugins/js/plugin.js"></script>
    <script src="./luckysheet.umd.js"></script>
</head>
<body>
<div id="luckysheet"></div>

<!-- demo feature, non-production use -->
<script src="./demoData/demoFeature.js"></script>
<script src="./demoData/sheetFormula.js"></script>
<script src="./demoData/sheetCell.js"></script>
<script src="./demoData/sheetConditionFormat.js"></script>
<script src="./demoData/sheetTable.js"></script>
<script src="./demoData/sheetComment.js"></script>
<script src="./demoData/sheetPivotTableData.js"></script>
<script src="./demoData/sheetPivotTable.js"></script>
<script src="./demoData/sheetSparkline.js"></script>
<script src="./demoData/sheetChart.js"></script>
<script src="./demoData/sheetPicture.js"></script>
<script src="./demoData/sheetDataVerification.js"></script>

<script>
	window.isDocumentModified = false;

    function setLuckysheetSize() {
        const container = document.getElementById('luckysheet');
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        container.style.width = viewportWidth + 'px';
        container.style.height = viewportHeight + 'px';

        // Luckysheet resize
        if (window.luckysheet && typeof luckysheet.resize === 'function') {
            setTimeout(() => {
                luckysheet.resize();

            }, 100);
        }
    }

    $(function () {
        // According to the browser language
        var lang = luckysheetDemoUtil.language() === 'zh' ? 'zh' : 'en';
        var isShare = luckysheetDemoUtil.getRequest().share;
        var gridKey = luckysheetDemoUtil.getRequest().gridKey;
        var options = null;

        if(isShare || gridKey){
            if(!gridKey){
                alert('If gridKey is not provided in the address bar, please add it in the source code')
            }
            options = {
                container: "luckysheet",
                lang: lang,
                allowUpdate:true,
                updateImageUrl: location.origin + "/luckysheet/api/updateImg",
                updateUrl: "ws://"+ location.host +"/luckysheet/websocket/luckysheet",
                gridKey: gridKey,
                loadUrl: location.origin + "/luckysheet/api/load",
                loadSheetUrl: location.origin + "/luckysheet/api/loadsheet"
            }
        }else{
            options = {
                container: 'luckysheet',
                lang: lang,
                forceCalculation:true,
                plugins: [],
                showinfobar: false,
                allowEdit: true,

  showSheetBarConfig: {
    add: true,
    menu: true,
    sheet: true
  },
  showConfigWindowResize: true,
                fontList:[
                    {
                    "fontName":"HanaleiFill",
                    "url":"./assets/iconfont/HanaleiFill-Regular.ttf"
                    },
                    {
                    "fontName":"Anton",
                    "url":"./assets/iconfont/Anton-Regular.ttf"
                    },
                    {
                    "fontName":"Pacifico",
                    "url":"./assets/iconfont/Pacifico-Regular.ttf"
                    }
                ],
                hook:{
                    cellDragStop: function (cell, postion, sheetFile, ctx, event) {
                        // console.info(cell, postion, sheetFile, ctx, event);
                    },
                    rowTitleCellRenderBefore:function(rowNum,postion,ctx){
                        // console.log(rowNum);
                    },
                    rowTitleCellRenderAfter:function(rowNum,postion,ctx){
                        // console.log(ctx);
                    },
                    columnTitleCellRenderBefore:function(columnAbc,postion,ctx){
                        // console.log(columnAbc);
                    },
                    columnTitleCellRenderAfter:function(columnAbc,postion,ctx){
                        // console.log(postion);
                    },
                    cellRenderBefore:function(cell,postion,sheetFile,ctx){
                        // console.log(cell,postion,sheetFile,ctx);
                    },
                    cellRenderAfter:function(cell,postion,sheetFile,ctx){
                        // console.log(postion);
                    },
                    cellMousedownBefore:function(cell,postion,sheetFile,ctx){
                        // console.log(postion);
                    },
                    cellMousedown:function(cell,postion,sheetFile,ctx){
                        // console.log(sheetFile);
                    },
                    sheetMousemove:function(cell,postion,sheetFile,moveState,ctx){
                        // console.log(cell,postion,sheetFile,moveState,ctx);
                    },
                    sheetMouseup:function(cell,postion,sheetFile,moveState,ctx){
                        // console.log(cell,postion,sheetFile,moveState,ctx);
                    },
                    cellAllRenderBefore:function(data,sheetFile,ctx){
                        // console.info(data,sheetFile,ctx)
                    },
                    updated:function(operate){
                        // console.info(operate)
                    },
                    cellUpdateBefore:function(r,c,value,isRefresh){
                        // console.info('cellUpdateBefore',r,c,value,isRefresh)
                    },
          cellUpdated: function(r, c, oldValue, newValue, isRefresh){
            console.info('cellUpdated', r, c, oldValue, newValue, isRefresh);
            window.isDocumentModified = true;
			if (window.AndroidInterface && typeof window.AndroidInterface.setIsDocumentModified === 'function') {
				window.AndroidInterface.setIsDocumentModified(window.isDocumentModified);
			}
            if (newValue && typeof newValue === 'object') {
            const v = newValue.v;
            const f = newValue.f;

            // Eğer formül var ama değer formül değilse, formülü kaldır
            if (f && f !== "") {
            let shouldRemoveFormula = false;

            // Durum 1: Değer boş
            if (!v || v === "" || v === null || v === undefined) {
                shouldRemoveFormula = true;
                console.log('Empty value detected, removing formula...');
            }
            // Durum 2: Değer string ama formül formatında değil (= ile başlamıyor)
            else if (typeof v === 'string' && !v.startsWith('=')) {
                shouldRemoveFormula = true;
                console.log('Non-formula text detected, removing formula...');
            }
            // Durum 3: Değer number ama kullanıcı direkt sayı girmiş (formül sonucu değil)
            else if (typeof v === 'number' && typeof oldValue === 'object' && oldValue?.f) {
                // Eğer eski değerde formül vardı ama yeni değer sadece sayıysa
                shouldRemoveFormula = true;
                console.log('Direct number input detected, removing formula...');
            }

            if (shouldRemoveFormula) {
                try {
                    const sheets = luckysheet.getluckysheetfile();
                    const currentSheet = sheets[luckysheet.getSheet().index];

                    if (currentSheet && currentSheet.data) {
                        if (currentSheet.data[r] && currentSheet.data[r][c]) {
                            if (currentSheet.data[r][c].f) {
                                delete currentSheet.data[r][c].f;
                                console.log('Formula deleted from data matrix');
                                luckysheet.refresh();
                            }
                        }
                    }

                    if (currentSheet && currentSheet.celldata && currentSheet.celldata.length > 0) {
                        const cellIndex = currentSheet.celldata.findIndex(cell => cell.r === r && cell.c === c);
                        if (cellIndex >= 0 && currentSheet.celldata[cellIndex].v && currentSheet.celldata[cellIndex].v.f) {
                            delete currentSheet.celldata[cellIndex].v.f;
                            console.log('Formula deleted from celldata');
                        }
                    }
                } catch (e) {
                    console.error('Error:', e);
                }
            }
        }
    }
},
                    sheetActivate:function(index, isPivotInitial, isNewSheet){
                        // console.info(index, isPivotInitial, isNewSheet)
                    },
                    rangeSelect:function(index, sheet){
                        // console.info(index, sheet)
                    },
                    commentInsertBefore:function(r, c){
                        // console.info(r, c)
                    },
                    commentInsertAfter:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentDeleteBefore:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentDeleteAfter:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentUpdateBefore:function(r, c, value){
                        // console.info(r, c, value)
                    },
                    commentUpdateAfter:function(r, c, oldCell, newCell ){
                        // console.info(r, c, oldCell, newCell)
                    },
                    cellEditBefore:function(range ){
                        // console.info(range)
                    },
                    workbookCreateAfter:function(json){
                        console.log('🎉 === LUCKYSHEET BAŞARIYLA YÜKLENDİ ===');
                        console.log('📊 Sheets loaded:', json?.length || 0);

                        // ✅ RESPONSIVE SIZE SET
                        setTimeout(() => {
                            setLuckysheetSize();
                        }, 500);

                        // ✅ Android API için global değişken
                        window.ExcelEditorAPI = {
                            isReady: () => true,
                            getInstance: () => luckysheet,
                            loadData: function(jsonString) {
                                try {
                                    console.log(' Loading data into Luckysheet...');
                                    const data = JSON.parse(jsonString);

                                    if (!Array.isArray(data) || data.length === 0) {
                                        console.error('❌ Invalid data format');
                                        return false;
                                    }

                                    if (typeof luckysheet.destroy === 'function') {
                                        luckysheet.destroy();
                                    }

                                    const newOptions = {
                                        container: 'luckysheet',
                                        lang: 'en',
                                        data: data,
                                        forceCalculation: true,
                                        showinfobar: false,
                                        plugins: [],
                                        hook: {
                cellUpdated: function(r, c, oldValue, newValue, isRefresh) {
    console.info('cellUpdated', r, c, oldValue, newValue, isRefresh)
	window.isDocumentModified = true;
	if (window.AndroidInterface && typeof window.AndroidInterface.setIsDocumentModified === 'function') {
		window.AndroidInterface.setIsDocumentModified(window.isDocumentModified);
	}

    if (newValue && typeof newValue === 'object') {
        const v = newValue.v;
        const f = newValue.f;

        // Eğer formül var ama değer formül değilse, formülü kaldır
        if (f && f !== "") {
            let shouldRemoveFormula = false;

            // Durum 1: Değer boş
            if (!v || v === "" || v === null || v === undefined) {
                shouldRemoveFormula = true;
                console.log('Empty value detected, removing formula...');
            }
            // Durum 2: Değer string ama formül formatında değil (= ile başlamıyor)
            else if (typeof v === 'string' && !v.startsWith('=')) {
                shouldRemoveFormula = true;
                console.log('Non-formula text detected, removing formula...');
            }
            // Durum 3: Değer number ama kullanıcı direkt sayı girmiş (formül sonucu değil)
            else if (typeof v === 'number' && typeof oldValue === 'object' && oldValue?.f) {
                // Eğer eski değerde formül vardı ama yeni değer sadece sayıysa
                shouldRemoveFormula = true;
                console.log('Direct number input detected, removing formula...');
            }

            if (shouldRemoveFormula) {
                try {
                    const sheets = luckysheet.getluckysheetfile();
                    const currentSheet = sheets[luckysheet.getSheet().index];

                    if (currentSheet && currentSheet.data) {
                        if (currentSheet.data[r] && currentSheet.data[r][c]) {
                            if (currentSheet.data[r][c].f) {
                                delete currentSheet.data[r][c].f;
                                console.log('Formula deleted from data matrix');
                                luckysheet.refresh();
                            }
                        }
                    }

                    if (currentSheet && currentSheet.celldata && currentSheet.celldata.length > 0) {
                        const cellIndex = currentSheet.celldata.findIndex(cell => cell.r === r && cell.c === c);
                        if (cellIndex >= 0 && currentSheet.celldata[cellIndex].v && currentSheet.celldata[cellIndex].v.f) {
                            delete currentSheet.celldata[cellIndex].v.f;
                            console.log('Formula deleted from celldata');
                        }
                    }
                } catch (e) {
                    console.error('Error:', e);
                }
            }
        }
    }
},
                workbookCreateAfter: function(newJson) {
                    console.log('✅ Data loaded successfully');
                    setTimeout(() => {
                        setLuckysheetSize();
                    }, 500);

                }
            }
        };

                                    luckysheet.create(newOptions);
                                    return true;
                                } catch (e) {
                                    console.error('❌ Load data error:', e);
                                    return false;
                                }
                            },
                            getData: () => {
                                try {
                                    return JSON.stringify({
                                        success: true,
                                        sheets: luckysheet.getAllSheets(),
                                        timestamp: new Date().toISOString()
                                    });
                                } catch (e) {
                                    return JSON.stringify({ error: e.message });
                                }
                            },
                            getCellValue: (row, col) => {
                                try {
                                    return luckysheet.getCellValue(row, col);
                                } catch (e) {
                                    return null;
                                }
                            },
                            setCellValue: (row, col, value) => {
                                try {
                                    luckysheet.setCellValue(row, col, value);
                                    return true;
                                } catch (e) {
                                    return false;
                                }
                            }
                        };

                        // Android'e hazır olduğunu bildir
                        if (window.AndroidInterface && window.AndroidInterface.onEditorReady) {
                            console.log('📱 Notifying Android - Editor is ready');
                            window.AndroidInterface.onEditorReady();
                        }
                    },
                    rangePasteBefore:function(range,data){
                        // console.info('rangePasteBefore',range,data)
                        // return false; //Can intercept paste
                    }
                },
                data:[{
                    "name": "Sheet1",
                    "index": 0,
                    "celldata": [],
                    "row": 100,
                    "column": 26,
                    "config": null,
                    "status": 1,
                    "order": 0,
                    "hide": 0,
                    "zoomRatio": 1.0
                }]
                //data:[sheetCell,sheetFormula,sheetConditionFormat,sheetSparkline,sheetTable,sheetComment,sheetPivotTableData,sheetPivotTable,sheetChart,sheetPicture,sheetDataVerification]
            }
        }

        // ✅ Luckysheet'i oluştur
        luckysheet.create(options);

        // ✅ Initial size set
        setTimeout(() => {
            setLuckysheetSize();
        }, 1000);
    });

    // ✅ Window resize event listener
    window.addEventListener('resize', function() {
        setTimeout(() => {
            setLuckysheetSize();
        }, 100);
    });

    // ✅ Android'den çağrılabilir resize function
    window.resizeLuckysheet = function() {
        setLuckysheetSize();
    };
</script>

</body>

</html>
