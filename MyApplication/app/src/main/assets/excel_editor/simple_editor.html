<!DOCTYPE html>
<html>

<head lang='zh'>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="renderer" content="webkit" />
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=0" />
    <title>Luckysheet</title>

    <!-- ‚úÖ TEMEL CSS - Body ve HTML height %100 -->
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #luckysheet {
            position: absolute;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

    <!-- ‚úÖ ORƒ∞Jƒ∞NAL CSS DOSYALARI -->
    <link rel='stylesheet' href='./plugins/css/pluginsCss.css' />
    <link rel='stylesheet' href='./plugins/plugins.css' />
    <link rel='stylesheet' href='./css/luckysheet.css' />
    <link rel='stylesheet' href='./assets/iconfont/iconfont.css' />

    <!-- ‚úÖ JQUERY √ñNCE Y√úKLE -->
    <script>
        // Minimal jQuery eƒüer yoksa
        if (typeof $ === 'undefined') {
            window.$ = function(selector) {
                if (typeof selector === 'function') {
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', selector);
                    } else {
                        setTimeout(selector, 0);
                    }
                    return;
                }
                return {
                    ready: function(fn) {
                        if (document.readyState === 'loading') {
                            document.addEventListener('DOMContentLoaded', fn);
                        } else {
                            setTimeout(fn, 0);
                        }
                    }
                };
            };
            window.jQuery = window.$;
        }
    </script>

    <!-- ‚úÖ CDN MOCK'LARI - Hatalarƒ± √∂nlemek i√ßin -->
    <script>
        console.log('üöÄ Luckysheet + CDN Mock ba≈ülatƒ±lƒ±yor...');

        // Vue.js mock - CDN hatasƒ±nƒ± √∂nler
        window.Vue = {
            use: function() { return this; },
            component: function() { return this; },
            directive: function() { return this; },
            filter: function() { return this; },
            mixin: function() { return this; },
            version: '2.6.11-mock'
        };

        // Vuex mock - CDN hatasƒ±nƒ± √∂nler
        window.Vuex = {
            Store: function() {
                return {
                    state: {},
                    commit: function() {},
                    dispatch: function() {},
                    getters: {}
                };
            },
            install: function() {},
            version: '3.4.0-mock'
        };

        // Element UI mock - CDN hatasƒ±nƒ± √∂nler
        window.ELEMENT = {
            size: 'small',
            zIndex: 3000
        };

        // ECharts mock - CDN hatasƒ±nƒ± √∂nler
        window.echarts = {
            init: function(dom, theme, opts) {

                return {
                    setOption: function(option) {  },
                    resize: function() { },
                    dispose: function() {  },
                    clear: function() {  },
                    getWidth: function() { return 400; },
                    getHeight: function() { return 300; },
                    on: function() {},
                    off: function() {}
                };
            },
            graphic: {
                LinearGradient: function() { return {}; }
            },
            version: '4.8.0-mock',
            registerTheme: function() {},
            registerMap: function() {}
        };

        // ChartMix mock - expendPlugins hatasƒ±nƒ± √∂nler
        window.chartmix = {
            init: function() { return {}; },
            create: function() { return {}; },
            version: '1.0.0-mock'
        };

    </script>


    <script src="./plugins/js/plugin.js"></script>

    <script src="./luckysheet.umd.js"></script>

</head>

<body>
<div id="luckysheet" style="margin:0px;padding:0px;position:absolute;height: 500px; width: 350px;left: 0px;top: 0px;"></div>
<!-- demo feature, non-production use -->
<script src="./demoData/demoFeature.js"></script>
<script src="./demoData/sheetFormula.js"></script>
<script src="./demoData/sheetCell.js"></script>
<script src="./demoData/sheetConditionFormat.js"></script>
<script src="./demoData/sheetTable.js"></script>
<script src="./demoData/sheetComment.js"></script>
<script src="./demoData/sheetPivotTableData.js"></script>
<script src="./demoData/sheetPivotTable.js"></script>
<script src="./demoData/sheetSparkline.js"></script>
<script src="./demoData/sheetChart.js"></script>
<script src="./demoData/sheetPicture.js"></script>
<script src="./demoData/sheetDataVerification.js"></script>

<script>

    $(function () {

        // According to the browser language
        var lang = luckysheetDemoUtil.language() === 'zh' ? 'zh' : 'en';
        var isShare = luckysheetDemoUtil.getRequest().share; // '?share=1' opens the collaborative editing mode
        var gridKey = luckysheetDemoUtil.getRequest().gridKey; // workbook id for collaborative editing, or directly define here
        var options = null;

        if(isShare || gridKey){
            // http://localhost:3000/?gridKey=12eyy789-kk45ofid-23737245
            if(!gridKey){
                alert('If gridKey is not provided in the address bar, please add it in the source code')
            }
            options = {
                container: "luckysheet",
                lang: lang,
                allowUpdate:true,
                updateImageUrl: location.origin + "/luckysheet/api/updateImg",
                updateUrl: "ws://"+ location.host +"/luckysheet/websocket/luckysheet",
                gridKey: gridKey,
                loadUrl: location.origin + "/luckysheet/api/load",
                loadSheetUrl: location.origin + "/luckysheet/api/loadsheet"
            }
        }else{
            // http://localhost:3000/
            options = {
                container: 'luckysheet',
                lang: lang,
                // pager: {
                // 	pageIndex: 1,
                // 	pageSize: 10,
                // 	total: 50,
                // 	selectOption: [10, 20]
                // },
                forceCalculation:false,
                plugins: [], // Chart plugin devre dƒ±≈üƒ± - hata √ßƒ±karƒ±yor
                fontList:[
                    {
                    "fontName":"HanaleiFill",
                    "url":"./assets/iconfont/HanaleiFill-Regular.ttf"
                    },
                    {
                    "fontName":"Anton",
                    "url":"./assets/iconfont/Anton-Regular.ttf"
                    },
                    {
                    "fontName":"Pacifico",
                    "url":"./assets/iconfont/Pacifico-Regular.ttf"
                    }
                ],
                hook:{
                    cellDragStop: function (cell, postion, sheetFile, ctx, event) {
                        // console.info(cell, postion, sheetFile, ctx, event);
                    },
                    rowTitleCellRenderBefore:function(rowNum,postion,ctx){
                        // console.log(rowNum);
                    },
                    rowTitleCellRenderAfter:function(rowNum,postion,ctx){
                        // console.log(ctx);
                    },
                    columnTitleCellRenderBefore:function(columnAbc,postion,ctx){
                        // console.log(columnAbc);
                    },
                    columnTitleCellRenderAfter:function(columnAbc,postion,ctx){
                        // console.log(postion);
                    },
                    cellRenderBefore:function(cell,postion,sheetFile,ctx){
                        // console.log(cell,postion,sheetFile,ctx);
                    },
                    cellRenderAfter:function(cell,postion,sheetFile,ctx){
                        // console.log(postion);
                    },
                    cellMousedownBefore:function(cell,postion,sheetFile,ctx){
                        // console.log(postion);
                    },
                    cellMousedown:function(cell,postion,sheetFile,ctx){
                        // console.log(sheetFile);
                    },
                    sheetMousemove:function(cell,postion,sheetFile,moveState,ctx){
                        // console.log(cell,postion,sheetFile,moveState,ctx);
                    },
                    sheetMouseup:function(cell,postion,sheetFile,moveState,ctx){
                        // console.log(cell,postion,sheetFile,moveState,ctx);
                    },
                    cellAllRenderBefore:function(data,sheetFile,ctx){
                        // console.info(data,sheetFile,ctx)
                    },
                    updated:function(operate){
                        // console.info(operate)
                    },
                    cellUpdateBefore:function(r,c,value,isRefresh){
                        // console.info('cellUpdateBefore',r,c,value,isRefresh)
                    },
                    cellUpdated:function(r,c,oldValue, newValue, isRefresh){
                        // console.info('cellUpdated',r,c,oldValue, newValue, isRefresh)
                    },
                    sheetActivate:function(index, isPivotInitial, isNewSheet){
                        // console.info(index, isPivotInitial, isNewSheet)
                    },
                    rangeSelect:function(index, sheet){
                        // console.info(index, sheet)
                    },
                    commentInsertBefore:function(r, c){
                        // console.info(r, c)
                    },
                    commentInsertAfter:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentDeleteBefore:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentDeleteAfter:function(r, c, cell){
                        // console.info(r, c, cell)
                    },
                    commentUpdateBefore:function(r, c, value){
                        // console.info(r, c, value)
                    },
                    commentUpdateAfter:function(r, c, oldCell, newCell ){
                        // console.info(r, c, oldCell, newCell)
                    },
                    cellEditBefore:function(range ){
                        // console.info(range)
                    },
                    workbookCreateAfter:function(json){
                        console.log('üéâ === LUCKYSHEET BA≈ûARIYLA Y√úKLENDƒ∞ ===');
                        console.log('üìä Sheets loaded:', json?.length || 0);


                        setTimeout(() => {
                            try {
                                console.log('üîß ===== DETAYLI CANVAS DEBUG =====');

                                // 1. Container analizi
                                const container = document.getElementById('luckysheet');
                                console.log('üì¶ Container analizi:', {
                                    offsetWidth: container.offsetWidth,
                                    offsetHeight: container.offsetHeight,
                                    clientWidth: container.clientWidth,
                                    clientHeight: container.clientHeight,
                                    scrollWidth: container.scrollWidth,
                                    scrollHeight: container.scrollHeight
                                });

                                // 2. Container children kontrol√º
                                console.log('üë∂ Container children:', container.children.length);
                                Array.from(container.children).forEach((child, i) => {
                                    console.log(`  Child ${i}: ${child.className || child.tagName} - ${child.offsetWidth}x${child.offsetHeight}`);
                                });

                                // 3. CSS kurallarƒ± kontrol√º
                                const allElements = document.querySelectorAll('#luckysheet *');
                                console.log('üîç Toplam child element:', allElements.length);

                                // 4. Canvas √∂zel kontrol√º
                                const canvases = document.querySelectorAll('#luckysheet canvas');
                                console.log('üé® Canvas detaylarƒ±:', canvases.length);

                                if (canvases.length === 0) {
                                    console.warn('‚ö†Ô∏è Hƒ∞√á CANVAS YOK! Bu ana sorun.');

                                    // Canvas olu≈üturmayƒ± zorla
                                    console.log('üîß Manuel canvas olu≈üturma deneniyor...');
                                    const manualCanvas = document.createElement('canvas');
                                    manualCanvas.width = container.offsetWidth;
                                    manualCanvas.height = container.offsetHeight;
                                    manualCanvas.style.position = 'absolute';
                                    manualCanvas.style.top = '0';
                                    manualCanvas.style.left = '0';
                                    manualCanvas.style.zIndex = '1';
                                    container.appendChild(manualCanvas);
                                    console.log('‚úÖ Manuel canvas eklendi');
                                } else {
                                    canvases.forEach((canvas, i) => {
                                        console.log(`Canvas ${i}:`, {
                                            width: canvas.width,
                                            height: canvas.height,
                                            offsetWidth: canvas.offsetWidth,
                                            offsetHeight: canvas.offsetHeight,
                                            style: canvas.style.cssText,
                                            display: window.getComputedStyle(canvas).display,
                                            visibility: window.getComputedStyle(canvas).visibility
                                        });

                                        // Canvas'ƒ± zorla g√∂ster
                                        canvas.style.display = 'block';
                                        canvas.style.visibility = 'visible';
                                        canvas.style.opacity = '1';
                                        canvas.style.position = 'absolute';
                                    });
                                }

                                // 5. Kritik Luckysheet elementleri kontrol√º
                                const criticalSelectors = [
                                    '.luckysheet-cell-main',
                                    '.luckysheet-grid-container',
                                    '.luckysheet-sheet-area',
                                    '.luckysheet-rows-h',
                                    '.luckysheet-cols-h',
                                    '.luckysheet-wa-editor'
                                ];

                                console.log('üîç Kritik element kontrol√º:');
                                criticalSelectors.forEach(selector => {
                                    const elements = document.querySelectorAll(selector);
                                    console.log(`${selector}: ${elements.length} adet`);

                                    elements.forEach(el => {
                                        const computedStyle = window.getComputedStyle(el);
                                        console.log(`  - ${el.offsetWidth}x${el.offsetHeight}, display: ${computedStyle.display}, visibility: ${computedStyle.visibility}`);

                                        // Zorla g√∂ster
                                        el.style.display = 'block';
                                        el.style.visibility = 'visible';
                                        el.style.opacity = '1';
                                    });
                                });

                                // 6. Refresh i≈ülemleri
                                console.log('üîÑ Refresh i≈ülemleri ba≈ülƒ±yor...');

                                if (typeof luckysheet.refresh === 'function') {
                                    luckysheet.refresh();
                                    console.log('‚úÖ luckysheet.refresh() √ßalƒ±≈ütƒ±rƒ±ldƒ±');
                                }

                                if (typeof luckysheet.resize === 'function') {
                                    luckysheet.resize();
                                    console.log('‚úÖ luckysheet.resize() √ßalƒ±≈ütƒ±rƒ±ldƒ±');
                                }

                                // 7. 2 saniye sonra tekrar kontrol
                                setTimeout(() => {
                                    const canvasesAfter = document.querySelectorAll('#luckysheet canvas');
                                    console.log('üîç 2 saniye sonra canvas sayƒ±sƒ±:', canvasesAfter.length);

                                    if (canvasesAfter.length === 0) {
                                        console.error('üí• SORUN: H√¢l√¢ hi√ß canvas yok! Luckysheet render edilmedi.');
                                    } else {
                                        console.log('‚úÖ Canvas var, UI render problemi olabilir.');
                                    }
                                }, 2000);

                            } catch (error) {
                                console.error('‚ùå Debug hatasƒ±:', error);
                            }
                        }, 1000);

                        // ‚úÖ Android API i√ßin global deƒüi≈üken
                        window.ExcelEditorAPI = {
                            isReady: () => true,
                            getInstance: () => luckysheet,
                            loadData: function(jsonString) {
                        try {
                            console.log('üì• Loading data into Luckysheet...');
                            console.log('üìä Data size:', jsonString.length, 'characters');

                            const data = JSON.parse(jsonString);
                            console.log('üìã Parsed data:', data);

                            // Data validation
                            if (!Array.isArray(data) || data.length === 0) {
                                console.error('‚ùå Invalid data format');
                                return false;
                            }

                            // Luckysheet'i yeniden ba≈ülat
                            if (typeof luckysheet.destroy === 'function') {
                                luckysheet.destroy();
                                console.log('üîÑ Previous instance destroyed');
                            }

                            // Yeni se√ßenekler
                            const newOptions = {
                                container: 'luckysheet',
                                lang: 'en',
                                data: data,
                                forceCalculation: false,
                                plugins: [],
                                fontList: [
                                    {
                                        "fontName":"Arial",
                                        "url":"./assets/iconfont/Arial.ttf"
                                    }
                                ],
                                hook: {
                                    workbookCreateAfter: function(newJson) {
                                        console.log('‚úÖ Data loaded successfully into Luckysheet');
                                        console.log('üìä New sheets count:', newJson?.length || 0);

                                        // Android'e ba≈üarƒ± bildir
                                        if (window.AndroidInterface && window.AndroidInterface.log) {
                                            window.AndroidInterface.log('‚úÖ Data loaded successfully');
                                        }
                                    },
                                    cellUpdated: function(r, c, oldValue, newValue, isRefresh) {
                                        // H√ºcre g√ºncellendiƒüinde
                                        console.log('üì± Cell updated:', r, c, oldValue, '=>', newValue);
                                    }
                                }
                            };

                            // Yeniden olu≈ütur
                            luckysheet.create(newOptions);

                            return true;
                        } catch (e) {
                            console.error('‚ùå Load data error:', e);
                            if (window.AndroidInterface && window.AndroidInterface.log) {
                                window.AndroidInterface.log('‚ùå LoadData error: ' + e.message);
                            }
                            return false;
                        }
                    },
                            getData: () => {
                                try {
                                    return JSON.stringify({
                                        success: true,
                                        sheets: luckysheet.getAllSheets(),
                                        timestamp: new Date().toISOString()
                                    });
                                } catch (e) {
                                    return JSON.stringify({ error: e.message });
                                }
                            },
                            getCellValue: (row, col) => {
                                try {
                                    return luckysheet.getCellValue(row, col);
                                } catch (e) {
                                    return null;
                                }
                            },
                            setCellValue: (row, col, value) => {
                                try {
                                    luckysheet.setCellValue(row, col, value);
                                    return true;
                                } catch (e) {
                                    return false;
                                }
                            }
                        };

                        // Android interface bildir
                        if (window.AndroidInterface && window.AndroidInterface.updateStatus) {
                            window.AndroidInterface.updateStatus('‚úÖ Excel Editor Hazƒ±r! (success)');
                        }
                           // Android'e hazƒ±r olduƒüunu bildir
        if (window.AndroidInterface && window.AndroidInterface.onEditorReady) {
        console.log('üì± Notifying Android - Editor is ready');
        window.AndroidInterface.onEditorReady();
        } else {
        console.warn('‚ö†Ô∏è AndroidInterface.onEditorReady not found');
        }
                    },
                    rangePasteBefore:function(range,data){
                        // console.info('rangePasteBefore',range,data)
                        // return false; //Can intercept paste
                    }
                },
                data:[{
            "name": "Sheet1",
            "index": 0,
            "celldata": [], // ‚úÖ Bo≈ü h√ºcreler
            "row": 100,
            "column": 26,
            "config": null,
            "status": 1,
            "order": 0,
            "hide": 0,
            "zoomRatio": 1.0
        }]
                //[sheetCell,sheetFormula,sheetConditionFormat,sheetSparkline,sheetTable,sheetComment,sheetPivotTableData,sheetPivotTable,sheetChart,sheetPicture,sheetDataVerification]
            }
        }
        luckysheet.create(options);

    })
</script>

</body>

</html>